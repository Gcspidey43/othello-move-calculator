function A(e){if(!e)return"pass";const t=String.fromCharCode(97+e.c),r=(e.r+1).toString();return t+r}function E(e,t){if(t===0)return[];const r=[],o=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];for(let s=0;s<8;s++)for(let n=0;n<8;n++){if(e[s][n]!==0)continue;let i=!1;for(const[c,f]of o)if(N(e,s,n,c,f,t)){i=!0;break}i&&r.push({r:s,c:n})}return r}function N(e,t,r,o,s,n){const i=-n;let c=t+o,f=r+s,u=!1;for(;c>=0&&c<8&&f>=0&&f<8&&e[c][f]===i;)u=!0,c+=o,f+=s;return u&&c>=0&&c<8&&f>=0&&f<8&&e[c][f]===n}function T(e,t,r){if(!t)return{board:e.map(f=>[...f]),flips:0};const o=e.map(f=>[...f]),{r:s,c:n}=t;o[s][n]=r;let i=0;const c=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];for(const[f,u]of c){const p=W(e,s,n,f,u,r);i+=p.length;for(const[a,l]of p)o[a][l]=r}return{board:o,flips:i}}function W(e,t,r,o,s,n){const i=-n,c=[];let f=t+o,u=r+s;for(;f>=0&&f<8&&u>=0&&u<8&&e[f][u]===i;)c.push([f,u]),f+=o,u+=s;return f>=0&&f<8&&u>=0&&u<8&&e[f][u]===n?c:[]}const F={PIECE_SQUARE:1,MOBILITY:78,FRONTIER:-50,STABILITY:100,DISC_DIFF:1},Z=[[100,-20,10,5,5,10,-20,100],[-20,-50,-2,-2,-2,-2,-50,-20],[10,-2,-1,-1,-1,-1,-2,10],[5,-2,-1,-1,-1,-1,-2,5],[5,-2,-1,-1,-1,-1,-2,5],[10,-2,-1,-1,-1,-1,-2,10],[-20,-50,-2,-2,-2,-2,-50,-20],[100,-20,10,5,5,10,-20,100]];function L(e,t){if(t===0)return 0;const r=$(e,t),o=K(e,t),s=Q(e,t),n=X(e,t),i=x(e,t),c=F.PIECE_SQUARE*r+F.MOBILITY*o+F.FRONTIER*s+F.STABILITY*n+F.DISC_DIFF*i;return Math.round(c)}function $(e,t){let r=0,o=0;const s=-t;for(let n=0;n<8;n++)for(let i=0;i<8;i++){const c=e[n][i],f=Z[n][i];c===t?r+=f:c===s&&(o+=f)}return r-o}function K(e,t){const r=E(e,t).length,o=E(e,-t).length;return 100*(r-o)/(r+o+1)}function Q(e,t){let r=0,o=0;const s=-t,n=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];for(let i=0;i<8;i++)for(let c=0;c<8;c++){const f=e[i][c];if(f===0)continue;let u=!1;for(const[p,a]of n){const l=i+p,S=c+a;if(l>=0&&l<8&&S>=0&&S<8&&e[l][S]===0){u=!0;break}}u&&(f===t?r++:f===s&&o++)}return-50*(r-o)/(r+o+1)}function X(e,t){const r=k(e);let o=0,s=0;const n=-t;for(let i=0;i<8;i++)for(let c=0;c<8;c++)r[i][c]&&(e[i][c]===t?o++:e[i][c]===n&&s++);return 100*(o-s)}function k(e){const t=Array(8).fill(null).map(()=>Array(8).fill(!1)),r=[[0,0],[0,7],[7,0],[7,7]];for(const[s,n]of r)e[s][n]!==0&&(t[s][n]=!0);let o=!0;for(;o;){o=!1;for(let s=0;s<8;s++)for(let n=0;n<8;n++)e[s][n]===0||t[s][n]||G(e,t,s,n)&&(t[s][n]=!0,o=!0)}return t}function G(e,t,r,o){const s=e[r][o];if(s===0)return!1;const n=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];for(const[i,c]of n)if(j(e,t,r,o,i,c,s))return!0;return!1}function j(e,t,r,o,s,n,i){let c=r+s,f=o+n;for(;c>=0&&c<8&&f>=0&&f<8;){if(e[c][f]!==i||!t[c][f])return!1;c+=s,f+=n}return!0}function x(e,t){let r=0,o=0;const s=-t;for(let n=0;n<8;n++)for(let i=0;i<8;i++){const c=e[n][i];c===t?r++:c===s&&o++}return r-o}const y=[],_=0x1a2b3c4d5e6f7a8bn;function H(){for(let e=0;e<64;e++)y[e]=[],y[e][0]=b(),y[e][1]=b()}function b(){const e=BigInt(Math.floor(Math.random()*4294967296)),t=BigInt(Math.floor(Math.random()*4294967296));return e<<32n|t}function J(e,t){let r=0n;for(let o=0;o<8;o++)for(let s=0;s<8;s++){const n=e[o][s];if(n!==0){const i=o*8+s,c=n===1?0:1;r^=y[i][c]}}return t===1&&(r^=_),r}function z(e,t,r,o,s){let n=e;n^=_;const i=r.r*8+r.c,c=o===1?0:1;n^=y[i][c];for(const[u,p]of s){const a=u*8+p,l=o===1?1:0;n^=y[a][l],n^=y[a][c]}return-o===1&&(n^=_),n}H();const D=999999,B=new Map,V=1e6;async function ee(e,t,r={},o){const s=r.depth??6,n=r.timeLimitMs??2e3,i=Date.now();let c=0,f=null,u=-D,p=[],a=0,l=!1;if(E(e,t).length===0)return{bestMove:null,bestMoveAlgebraic:"pass",flips:0,score:L(e,t),pv:["pass"],nodes:1,timeMs:Date.now()-i,depthSearched:0};for(let I=1;I<=s&&!l&&!(Date.now()-i>=n);I++)try{const h=i+n,v=C(e,t,I,-D,D,!0,[],J(e,t),h,o?w=>{o({...w,depth:I,timeMs:Date.now()-i})}:void 0);if(v.timeout){l=!0;break}c+=v.nodes,f=v.bestMove,u=v.score,p=v.pv,a=I,o&&o({nodes:c,depth:I,bestMove:A(f),timeMs:Date.now()-i})}catch(h){if(h instanceof Error&&h.message==="TIMEOUT")l=!0;else throw h}let d=0;return f&&(d=T(e,f,t).flips),{bestMove:f,bestMoveAlgebraic:A(f),flips:d,score:u,pv:p,nodes:c,timeMs:Date.now()-i,depthSearched:a}}function te(e,t,r){if(!t)return[];const o=[],{r:s,c:n}=t,i=-r,c=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];for(const[f,u]of c){const p=[];let a=s+f,l=n+u;for(;a>=0&&a<8&&l>=0&&l<8&&e[a][l]===i;)p.push([a,l]),a+=f,l+=u;a>=0&&a<8&&l>=0&&l<8&&e[a][l]===r&&o.push(...p)}return o}function C(e,t,r,o,s,n,i,c,f,u){let p=1;if(f&&p%1024===0&&Date.now()>f)return{score:-D,bestMove:null,pv:i,nodes:p,timeout:!0};const a=c.toString(),l=B.get(a);if(l&&l.depth>=r){if(l.flag==="EXACT")return{score:l.value,bestMove:l.bestMove,pv:i,nodes:p};if(l.flag==="LOWER"&&l.value>=s)return{score:l.value,bestMove:l.bestMove,pv:i,nodes:p};if(l.flag==="UPPER"&&l.value<=o)return{score:l.value,bestMove:l.bestMove,pv:i,nodes:p}}if(r===0){const M=L(e,t);return{score:n?M:-M,bestMove:null,pv:i,nodes:p}}const S=n?t:-t,d=E(e,S);if(d.length===0){const M=-S;if(E(e,M).length===0){const g=L(e,t);return{score:n?g:-g,bestMove:null,pv:[...i,"pass"],nodes:p}}else{const g=C(e,t,r-1,o,s,!n,[...i,"pass"],c,f);return{score:g.score,bestMove:null,pv:g.pv,nodes:p+g.nodes}}}const I=ne(e,d,S);let h=null,v=n?-D:D,w=i,U=o;for(const M of I){const{board:q}=T(e,M,S),g=[...i,A(M)],P=te(e,M,S),Y=M?z(c,e,M,S,P):c,m=C(q,t,r-1,o,s,!n,g,Y,f,u);if(p+=m.nodes,m.timeout)return{score:v,bestMove:h,pv:w,nodes:p,timeout:!0};if(u&&p%100===0&&u({nodes:p,bestMove:A(h)}),n?(m.score>v&&(v=m.score,h=M,w=m.pv),o=Math.max(o,m.score)):(m.score<v&&(v=m.score,h=M,w=m.pv),s=Math.min(s,m.score)),s<=o)break}if(B.size<V){let M;v<=U?M="UPPER":v>=s?M="LOWER":M="EXACT",B.set(a,{key:c,depth:r,value:v,flag:M,bestMove:h})}return{score:v,bestMove:h,pv:w,nodes:p}}function ne(e,t,r){const o=new Set(["0,0","0,7","7,0","7,7"]);return t.sort((s,n)=>{if(!s||!n)return 0;const i=`${s.r},${s.c}`,c=`${n.r},${n.c}`,f=o.has(i),u=o.has(c);if(f&&!u)return-1;if(!f&&u)return 1;const p=T(e,s,r).flips,a=T(e,n,r).flips;if(p!==a)return a-p;const l=T(e,s,r).board,S=T(e,n,r).board,d=-r,I=E(l,d).length,h=E(S,d).length;return I-h})}let O=null,R=!1;self.onmessage=async e=>{const t=e.data;if(t.cmd==="stop"){R=!0;return}if(t.cmd==="search")try{R=!1;const r={type:"info",nodes:0,depth:0,bestMoveSoFar:"",timeMs:0,requestId:t.requestId};self.postMessage(r),O=ee(t.board,t.color,{depth:t.depth,timeLimitMs:t.timeLimitMs},s=>{if(!R){const n={type:"info",nodes:s.nodes,depth:s.depth,bestMoveSoFar:s.bestMove,timeMs:s.timeMs,requestId:t.requestId};self.postMessage(n)}});const o=await O;if(!R){const s={type:"result",result:o,requestId:t.requestId};self.postMessage(s)}}catch(r){const o={type:"error",error:r instanceof Error?r.message:"Unknown error",requestId:t.requestId};self.postMessage(o)}finally{O=null}};
